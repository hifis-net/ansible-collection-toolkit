# SPDX-FileCopyrightText: Helmholtz-Zentrum Dresden-Rossendorf (HZDR)
#
# SPDX-License-Identifier: Apache-2.0

# Dockerfile for testing privilege escalation with non-root user
# This ensures the role properly uses 'become: true' directives

FROM {{ item.image }}

# Create ansible user with sudo permissions
ENV ANSIBLE_USER=ansible \
    SUDO_GROUP=sudo \
    DEBIAN_FRONTEND=noninteractive

# Create non-root user with sudo access
RUN set -xe \
    && groupadd -r ${ANSIBLE_USER} \
    && useradd -m -g ${ANSIBLE_USER} ${ANSIBLE_USER} \
    && usermod -aG ${SUDO_GROUP} ${ANSIBLE_USER} \
    && sed -i "/^%${SUDO_GROUP}/s/ALL\$/NOPASSWD:ALL/g" /etc/sudoers

# NOTE: Do not switch to non-root user here - systemd must run as root
# Ansible will connect as the ansible user via ansible_user inventory variable
